{% extends 'subscription_pools/_base.html' %}
{% from 'subscription_pool_elements/_macros.html' import elements_display %}
{% from 'illusts/_macros.html' import illusts_display %}
{% from 'posts/_macros.html' import recent_posts %}

{% block title %}{{ subscription_pool.header }}{% endblock %}

{% block content %}
    <div id="subscription-pool-heading" class="heading">{{ subscription_pool.header }}</div>
    <div id="subscription-pool-content">
        {% include "subscription_pools/_sidebar.html" %}
        {% include "subscription_pools/_site_content.html" %}
    </div>
    {{ elements_display(helpers.subscription_pool.element_search(subscription_pool), subscription_pool.element_count, 'subscription-elements') }}
    {{ illusts_display(helpers.subscription_pool.illust_search(subscription_pool), subscription_pool.illust_count, 'subscription-illusts', False) }}
    <div id="subscription-pool-posts">
        {{ recent_posts(subscription_pool.recent_posts, subscription_pool.post_count, helpers.subscription_pool.post_search(subscription_pool)) }}
    </div>
{% endblock %}

{% block pagescript %}
    {% if subscription_pool.status == 'manual' or subscription_pool.status == 'automatic' %}
        <script>
            setTimeout(function () {
                window.location.reload();
            }, 15000);
        </script>
    {% endif %}
    {% if job_status is not none and job_status['stage'] != 'done' %}
        <script>
            const job_interval = setInterval(function () {
                let url = "{{ url_for('subscription_pool.status_json', id=subscription_pool.id, job=job_id) }}";
                fetch(url)
                    .then((resp)=>resp.json())
                    .then((data)=>{
                        console.log("Job interval:", JSON.stringify(data, null, 4));
                        if (data.error) {
                            Prebooru.error(data.message);
                            clearInterval(job_interval);
                        } else {
                            document.getElementById('subscription-pool-job-stage').innerHTML = data.item.stage || '<em>none</em>';
                            document.getElementById('subscription-pool-job-range').innerHTML = data.item.range || '<em>none</em>';
                            document.getElementById('subscription-pool-job-records').innerText = data.item.records;
                            document.getElementById('subscription-pool-job-elements').innerText = data.item.elements;
                            document.getElementById('subscription-pool-job-illust-creates').innerText = data.item.illust_creates;
                            document.getElementById('subscription-pool-job-illust-updates').innerText = data.item.illust_updates;
                            document.getElementById('subscription-pool-job-downloads').innerText = data.item.downloads;
                            if (data.item.stage === 'done') {
                                clearInterval(job_interval);
                            }
                        }
                    });
            }, 2000);
        </script>
    {% endif %}
{% endblock %}
